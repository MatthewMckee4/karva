name: Diff

on:
  workflow_call:

env:
  PYTHON_VERSION: "3.13"

jobs:
  diff:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false

      - name: Update Rust toolchain
        run: rustup update

      - uses: astral-sh/setup-uv@5a7eac68fb9809dea845d802897dc5c723910fa3 # v7.1.3
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          activate-environment: "false"
          enable-cache: "false"

      - name: Set up Python
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c # v4.9.1
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build PR wheel
        run: |
          uv run --no-project --with maturin maturin build --out new-karva

      - name: Checkout main branch
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          ref: main
          clean: false
          persist-credentials: false

      - name: Build main wheel
        run: |
          uv run --no-project --with maturin maturin build --out old-karva

      - name: Restore PR branch files
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          clean: false
          persist-credentials: false

      - name: Run karva_diff
        run: |
          OLD_WHEEL=$(ls old-karva/*.whl)
          NEW_WHEEL=$(ls new-karva/*.whl)
          cargo run -p karva_diff -- "$OLD_WHEEL" "$NEW_WHEEL" out.txt

      - name: Read diff output
        id: diff
        run: |
          {
            echo "diff<<EOF"
            cat out.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          if [ -s out.txt ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Find existing comment
        uses: peter-evans/find-comment@3eae4d37986fb5a8592848f6a574fdf654e61f9e # v3.1.0
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "<!-- karva-diff-comment -->"

      - name: Write comment body (no changes)
        if: steps.diff.outputs.has_changes == 'false'
        run: |
          cat > comment-no-changes.md <<'EOF'
          <!-- karva-diff-comment -->
          ## Project Diff Results

          No changes between this PR and main.
          EOF

      - name: Create or update comment (no changes)
        if: steps.diff.outputs.has_changes == 'false'
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body-path: comment-no-changes.md

      - name: Write comment body (with changes)
        if: steps.diff.outputs.has_changes == 'true'
        run: |
          cat > comment-with-changes.md <<'EOF'
          <!-- karva-diff-comment -->
          ## Project Diff Results

          <details>
          <summary>View diff</summary>

          ```diff
          ${{ steps.diff.outputs.diff }}
          ```

          </details>
          EOF

      - name: Create or update comment (with changes)
        if: steps.diff.outputs.has_changes == 'true'
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body-path: comment-with-changes.md
